!function(){function o(t,i,e){return 0<(t=t+i<e?e-i:t)?0:t}var e=!(!(e=document.createElement("canvas")).getContext||!e.getContext("2d")),h="cropbox";function t(n){function s(t,i,e){this.width=null,this.height=null,this.img_width=null,this.img_height=null,this.img_left=0,this.img_top=0,this.minPercent=null,this.options=i,this.$image=t,this.$image.hide().prop("draggable",!1).addClass("cropImage").wrap('<div class="cropFrame" />'),this.$frame=this.$image.parent(),this.on_load=e||function(){},this.init()}s.prototype={init:function(){var i,o=this,t=n("<div/>",{class:"cropControls"}).append(n("<span>"+this.options.label+"</span>")).append(n("<button/>",{class:"cropZoomIn",type:"button"}).on("click",n.proxy(this.zoomIn,this))).append(n("<button/>",{class:"cropZoomOut",type:"button"}).on("click",n.proxy(this.zoomOut,this)));this.$frame.append(this.options.controls||t),this.updateOptions(),"function"==typeof n.fn.hammer||"undefined"!=typeof Hammer?((t="function"==typeof n.fn.hammer?this.$image.hammer().data("hammer"):Hammer(this.$image.get(0))).get("pan").set({direction:Hammer.DIRECTION_ALL,threshold:0}),t.get("pinch").set({enable:!0}),t.on("panleft panright panup pandown",function(t){(i=i||{startX:o.img_left,startY:o.img_top}).dx=t.deltaX,i.dy=t.deltaY,t.preventDefault(),o.drag.call(o,i,!0)}).on("panend pancancel",function(t){t.preventDefault(),i=null,o.update.call(o)}).on("doubletap",function(t){t.preventDefault(),o.zoomIn.call(o)}).on("pinchin",function(t){t.preventDefault(),o.zoomOut.call(o)}).on("pinchout",function(t){t.preventDefault(),o.zoomIn.call(o)})):(this.$image.on("dragstart",function(){return!1}),this.$image.on("mousedown."+h,function(i){var e={startX:o.img_left,startY:o.img_top};i.preventDefault(),n(document).on("mousemove."+h,function(t){e.dx=t.pageX-i.pageX,e.dy=t.pageY-i.pageY,o.drag.call(o,e,!0)}).on("mouseup."+h,function(){o.update.call(o),n(document).off("mouseup."+h),n(document).off("mousemove."+h)})})),n.fn.mousewheel&&this.$image.on("mousewheel."+h,function(t){t.preventDefault(),(t.deltaY<0?o.zoomIn:o.zoomOut).call(o)})},updateOptions:function(){var t=this,i=(t.img_top=0,t.img_left=0,t.$image.css({width:"",left:t.img_left,top:t.img_top}),t.$frame.width(t.options.width).height(t.options.height),t.$frame.off("."+h),t.$frame.removeClass("hover"),"always"===t.options.showControls||"auto"===t.options.showControls&&("ontouchstart"in window||"onmsgesturechange"in window)?t.$frame.addClass("hover"):"never"!==t.options.showControls&&(t.$frame.on("mouseenter."+h,function(){t.$frame.addClass("hover")}),t.$frame.on("mouseleave."+h,function(){t.$frame.removeClass("hover")})),new Image);i.onload=function(){t.width=i.width,t.height=i.height,i.src="",i.onload=null,t.percent=void 0,t.fit.call(t),t.options.result?t.setCrop.call(t,t.options.result):t.zoom.call(t,t.minPercent),t.$image.fadeIn("fast"),t.on_load.call(t)},i.src=t.$image.attr("src")},remove:function(){var t;"function"==typeof n.fn.hammer?t=this.$image.data("hammer"):"undefined"!=typeof Hammer&&(t=Hammer(this.$image.get(0))),t&&t.off("panleft panright panup pandown panend pancancel doubletap pinchin pinchout"),this.$frame.off("."+h),this.$image.off("."+h),this.$image.css({width:"",left:"",top:""}),this.$image.removeClass("cropImage"),this.$image.removeData(h),this.$image.insertAfter(this.$frame),this.$frame.removeClass("cropFrame"),this.$frame.removeAttr("style"),this.$frame.empty(),this.$frame.remove()},fit:function(){var t=this.options.width/this.width,i=this.options.height/this.height;this.minPercent=i<=t?t:i},setCrop:function(t){this.percent=Math.max(this.options.width/t.cropW,this.options.height/t.cropH),this.img_width=Math.ceil(this.width*this.percent),this.img_height=Math.ceil(this.height*this.percent),this.img_left=-Math.floor(t.cropX*this.percent),this.img_top=-Math.floor(t.cropY*this.percent),this.$image.css({width:this.img_width,left:this.img_left,top:this.img_top}),this.update()},zoom:function(t){var i=this.percent;this.percent=Math.max(this.minPercent,Math.min(this.options.maxZoom,t)),this.img_width=Math.ceil(this.width*this.percent),this.img_height=Math.ceil(this.height*this.percent),i?(t=this.percent/i,this.img_left=o((1-t)*this.options.width/2+t*this.img_left,this.img_width,this.options.width),this.img_top=o((1-t)*this.options.height/2+t*this.img_top,this.img_height,this.options.height)):(this.img_left=o((this.options.width-this.img_width)/2,this.img_width,this.options.width),this.img_top=o((this.options.height-this.img_height)/2,this.img_height,this.options.height)),this.$image.css({width:this.img_width,left:this.img_left,top:this.img_top}),this.update()},zoomIn:function(){this.zoom(this.percent+(1-this.minPercent)/(this.options.zoom-1||1))},zoomOut:function(){this.zoom(this.percent-(1-this.minPercent)/(this.options.zoom-1||1))},drag:function(t,i){var e;this.img_left=o(t.startX+t.dx,this.img_width,this.options.width),this.img_top=o(t.startY+t.dy,this.img_height,this.options.height),!1!==(e=this.options.onDragging&&n.isFunction(this.options.onDragging)?this.options.onDragging.call(null,{top:this.img_top,left:this.img_left}):e)&&(this.$image.css({left:this.img_left,top:this.img_top}),i||this.update())},update:function(){this.result={cropX:-Math.ceil(this.img_left/this.percent),cropY:-Math.ceil(this.img_top/this.percent),cropW:Math.floor(this.options.width/this.percent),cropH:Math.floor(this.options.height/this.percent),stretch:1<this.minPercent},this.$image.trigger(h,[this.result,this])},getDataURL:function(){if(!e)return!1;var t=document.createElement("canvas"),i=t.getContext("2d");return t.width=this.options.width,t.height=this.options.height,i.drawImage(this.$image.get(0),this.result.cropX,this.result.cropY,this.result.cropW,this.result.cropH,0,0,this.options.width,this.options.height),t.toDataURL()},getBlob:function(){for(var t=(t=this.getDataURL()).split(","),i=atob(t[1]),t=t[0].split(":")[1].split(";")[0],e=new ArrayBuffer(i.length),o=new Uint8Array(e),n=0;n<i.length;n++)o[n]=i.charCodeAt(n);return new Blob([e],{type:t})}},n.fn[h]=function(e,o){return this.each(function(){var t=n(this),i=t.data(h);i?e&&(n.extend(i.options,e),i.updateOptions()):(i=n.extend({},n.fn[h].defaultOptions,e),t.data(h,new s(t,i,o)))})},n.fn[h].defaultOptions={width:200,height:200,zoom:10,maxZoom:1,controls:null,showControls:"auto",label:"Drag to crop",onDragging:null}}"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?t(require("jquery")):"function"==typeof define&&define.amd?define(["jquery"],t):t(window.jQuery||window.Zepto)}();