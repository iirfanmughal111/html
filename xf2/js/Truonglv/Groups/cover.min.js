!function(r,t){"use strict";XF.Groups_CoverEditor=XF.Element.newHandler({options:{width:null,height:null,crop:{},guideText:null,save:null,frame:null,hammerJs:null},$img:null,$frame:null,$guide:null,cropData:{w:0,h:0,x:0,y:0,imgW:0,imgH:0},loading:!1,init:function(){if(this.$frame=XF.findRelativeIf(this.options.frame,this.$target),this.$img=this.$frame.find(".groupCover--img"),!this.$img.length)throw new Error("No cover image found.");this.$target.bind("click",r.proxy(this,"saveCrop")),this.options.guideText&&(this.$guide=r("<span />").addClass("groupCover--guide").text(this.options.guideText),this.$guide.appendTo(this.$frame)),this.cropData=r.extend(this.cropData,this.options.crop),null===this.options.height&&(this.options.height=200);var i,o=0,e=this;r(t).on("resize",function(){i&&(clearTimeout(i),i=0),i=setTimeout(function(){i=0;var t=e.$img.width();o!==t&&(e.onResized(),o=t)},100)}),XF.Feature.has("touchevents")&&this.options.hammerJs?XF.Loader.loadJs([this.options.hammerJs],function(){e.createCropBox()}):this.createCropBox()},saveCrop:function(t){var i,o;this.loading||(this.loading=!0,o={crop:(i=this).cropData,reposition:1},XF.ajax("POST",this.options.save,o,function(t){t.redirect&&XF.redirect(t.redirect)}).always(function(){i.loading=!1}))},setCropData:function(t,i){this.cropData[t]=i},onResized:function(){this.$img.data("cropbox")&&this.$img.data("cropbox").update()},createCropBox:function(){var t=this.options.height,o=this,t=Math.min(t,o.getRatio()*(o.getImgHeight()-t));t=Math.max(t,200),this.$frame.height(t),this.$img.cropbox({width:this.$img.width(),height:t,showControls:"never",onDragging:function(t){if(!t)return!0;var i=o.getRatio()*(o.getImgHeight()-o.options.height);return!(Math.abs(t.top)>=i)}}).on("cropbox",r.proxy(this,"onCropBox"))},getImgWidth:function(){return this.cropData.imgW<1?this.$img[0].naturalWidth:this.cropData.imgW},getImgHeight:function(){return this.cropData.imgH<1?this.$img[0].naturalHeight:this.cropData.imgH},getRatio:function(){return this.$img.width()/this.getImgWidth()},onCropBox:function(t,i,o){this.setCropData("y",this.$img.css("top")),this.setCropData("w",this.$img.width()),this.setCropData("h",this.$frame.height()),this.cropData.imgH<1&&this.setCropData("imgH",this.$img[0].naturalWidth),this.cropData.imgW<1&&this.setCropData("imgW",this.$img[0].naturalHeight)}}),XF.Element.register("tlg-cover-editor","XF.Groups_CoverEditor")}(jQuery,this,document);