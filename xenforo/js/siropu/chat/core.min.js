!function(e,g,t,u){var p=/Mobi|Android/i.test(navigator.userAgent);var C=e("#siropuChat");var x=e("#siropuChatHeader");var y=e("#siropuChatToggleUsers");var E=e("#siropuChatTabs");var b=E.find('a[data-target="room-list"]');var j=E.find('a[data-target="conv-list"]');var k=E.find('a[data-target="conv-form"]');var w=e("#siropuChatContent");var F=e(".siropuChatMessages");var r=e("#siropuChatStartConversation");var s=e(".siropuChatConversation.siropuChatUsers");var l=e("#siropuChatNoConversations");var G=e("#siropuChatRooms");var D=e("#siropuChatSettings");var d=e("#siropuChatEditor");var i=e("#siropuChatWhosTyping");var a=d.find("form");var o=a.find('textarea[name="message_html"]');var n=a.find('button[type="submit"]');var A=e("#siropuChatBar");var z=e("#siropuChatBarMessageContainer");var q=e("#siropuChatBarUserCount span");var h=C.hasClass("siropuChatPage");var m=C.hasClass("siropuChatAllPages");var B=e(".siropuChatLogout");var f=e('.p-navEl-link[data-nav-id="siropuChat"]');var c=e(".p-navgroup-link--chat");var v;XF.SiropuChat={};XF.SiropuChat.Core=XF.Element.newHandler({options:{active:false},userId:0,canUseChat:true,loggedIn:e("#XF").data("logged-in"),channel:"room",screenSize:"l",serverTime:0,pageFocus:true,pageTitle:e("title").text(),tabNotification:false,tabNotificationInterval:null,roomId:1,primaryRoomId:0,lastId:{},convId:0,convUnread:{},convOnly:0,convItems:[],guestRoom:0,noticeLastUpdate:0,userLastUpdate:0,convLastActive:0,convLastUpdate:0,userUpdateInterval:30,convUpdateInterval:60,messageDisplayLimit:25,notificationTimeout:5000,isVisible:C.is(":visible"),refreshActive:5000,refreshActiveHidden:15000,refreshInactive:30000,refreshInactiveHidden:60000,refreshInterval:0,refreshSet:null,inverse:0,floadCheck:0,roomFloodCheck:0,bypassFloodCheck:false,displayNavCount:false,forceRoom:false,inIframe:g.frameElement,dynamicTitle:true,activeUsers:{},commands:{},sounds:{},loadMoreButton:{room:true,conv:true},forceAutoScroll:false,joinCommand:null,loadRooms:false,internalLinksInNewTab:false,roomTabUserCount:true,convTabCount:"onlineCount",userListOrder:"most_active",hideTabs:false,whosTyping:{room:false,conv:false},whosTypingInterval:null,init:function(){var H=this;if(!XF.Cookie.get("siropu_chat_channel")){XF.Cookie.set("siropu_chat_channel",this.channel);if(this.inRoom()){XF.Cookie.set("siropu_chat_room_id",e(".siropuChatRoom.siropuChatMessages:visible").data("room-id"))}else{XF.Cookie.set("siropu_chat_conv_id",e(".siropuChatConversation.siropuChatMessages:visible").data("conv-id"))}}o.on("editor:init",function(J,I){v=I});this.getScreenSize();this.startRefreshInterval();this._initSubmitForm();this._initTabs();this._initRoomListActions();this._initRoomActions();this._initConversations();this._initAutoScrollToggle();this._initSounds();this._initOnLoad();this._initWhosTyping();y.on("click",e.proxy(this,"toggleUsers"));D.on("change",e.proxy(this,"saveSettings"));A.on("click",e.proxy(this,"toggleChat"));C.on("new-message",e.proxy(this,"newMessage"));if(m&&XF.siropuChatNoFooterPadding===undefined){e(".p-footer").css("padding-bottom",60)}if(p){e('textarea[name="message_html"]').on("editor:init",function(I,J){J.events.on("focus",function(L){var K=e(I.target);if(K.parents("#siropuChat").length==0&&m){A.fadeOut();setTimeout(function(){C.trigger("toggle-bar")},500)}});J.events.on("blur",function(L){var K=e(I.target);if(K.parents("#siropuChat").length==0&&m){A.fadeIn();setTimeout(function(){C.trigger("toggle-bar")},500)}})});if(c.length){c.attr("data-badge",parseInt(f.find(".badge").text()))}}e(g).scroll(function(){if(e(".p-navSticky").length&&e(".siropuChatAllPages.siropuChatMaximized").length){H.adjustContentHeight()}});e(g).resize(function(){if(p){return}H.getScreenSize();H.adjustContentHeight();H.adjustInputBox();if(H.inRoom()){if(E.length){H.switchRoom(H.roomId,true)}else{if(!H.getMiscSetting("hide_chatters")){var I=e('.siropuChatRoom.siropuChatUsers[data-room-id="'+H.roomId+'"]');if(H.screenSizeIs("s")){I.hide()}else{I.show()}}}}else{H.switchConversation(H.convId)}});e(g).blur(function(){H.pageFocus=false;if(!H.inIframe){H.clearWhosTypingInterval()}});e(g).focus(function(){H.pageFocus=true;if(H.tabNotificationInterval){clearInterval(H.tabNotificationInterval);e("title").text(H.pageTitle)}H._initWhosTyping()});e(t).on("keyup",function(I){if(I.which==27&&m&&H.isVisible){H.toggleChat()}});e(t).on("click",".siropuChatMessageRow.siropuChatBot ol li b",function(){H.editorSetHtml(e(this).html())});e(t).on("siropuChat:show-load-more",".siropuChatMessages",function(){if(H.inRoom()&&!H.loadMoreButton.room||H.inConv()&&!H.loadMoreButton.conv){return}if(e(this).find("> li[data-id]").length<H.messageDisplayLimit){return}var J=e('<li class="siropuChatLoadMoreMessages" style="display: none;" />');var I=e('<a class="button button--link" data-xf-click="siropu-chat-load-more-messages" />');I.html(XF.phrase("siropu_chat_load_more_messages")).appendTo(J);if(e(this).find(".siropuChatLoadMoreMessages").length){return e(this).find(".siropuChatLoadMoreMessages").fadeIn()}if(H.inverse){J.appendTo(e(this)).fadeIn();e(this).scrollTop(1000000)}else{J.prependTo(e(this)).fadeIn()}XF.activate(J)});e(t).on("click",function(I){if(m&&H.isVisible&&I.target.className.match("p-")){A.trigger("click")}});this.$target.on("mouseover mouseout",".siropuChatMessageRow",function(J){var K=e(this).find(".siropuChatMessageActions");var I=e(this).find(".siropuChatDateTime");if(K.length){if(J.type=="mouseover"){K.show();I.hide()}else{K.hide();I.show()}}});e(t).on("click",".siropuChatMessageText .link--internal",function(I){if(H.internalLinksInNewTab){I.preventDefault();g.open(e(this).attr("href"),"_blank")}});e("#siropuChatBarDisable").on("click",function(){e(this).find("i").removeClass("fa-toggle-off").addClass("fa-toggle-on");setTimeout(function(){D.find('input[name="disable"]').trigger("click")},1000)});setTimeout(function(){if(H.inRoom()&&H.loadRooms&&!H.getRoomCount()){b.click()}else{if(H.inConv()&&H.getConvCount()){s.find(".siropuChatActiveConversation").trigger("click",true)}}if(H.hasUnreadConversations()){H.addBarNewMessageClass()}},500);if(this.inRoom()&&this.isResponsive()){e(".siropuChatRoom.siropuChatUsers").hide()}if(this.inConv()){this.orderConversations()}if(this.lastId[this.roomId]===undefined){this.lastId[this.roomId]=1}this.joinCommand=this.getCommand("join");this.noticeLastUpdate=this.serverTime;this.userLastUpdate=this.serverTime;this.convLastUpdate=this.serverTime;this.convLastActive=this.serverTime;this.autoScroll();this.toggleLogout();this.toggleBotMessages()},getScreenSize:function(){if(g.matchMedia("(max-width: 576px)").matches){this.screenSize="s"}else{if(g.matchMedia("(min-width: 768px)").matches){this.screenSize="m"}else{this.screenSize="l"}}},getRoomCount:function(){return C.find(".siropuChatMessages[data-room-id]").length},getConvCount:function(){return C.find("li[data-conv-id]").length},screenSizeIs:function(H){return this.screenSize==H},isResponsive:function(){return(this.screenSizeIs("s")||C.hasClass("siropuChatSidebar"))},newMessage:function(I,H){if(!this.pageFocus&&H.isSelf[this.roomId]===true){return}if(H.action!="join"){this.playSound(H);if(!this.pageFocus){this.displayTabNotification(H);this.initDesktopNotification(H)}}},doMessageActions:function(N){if(!N.actions){return}for(var I in N.actions){var L=N.actions[I];for(var S in L){if(I=="rooms"&&this.lastId[S]===undefined){continue}if(I=="rooms"){var H=e('.siropuChatMessages[data-room-id="'+S+'"]')}else{var H=e('.siropuChatMessages[data-conv-id="'+S+'"]')}for(var Q in L[S]){var K=L[S][Q];var T=H.find('> li[data-id="'+Q+'"]');for(var R in K.action){if(T.attr("data-last-change")==K.action[R]){continue}switch(R){case"edit":T.find(".siropuChatMessageText").html(K.html);break;case"delete":T.fadeOut();break;case"like":var J=T.find(".siropuChatMessageLikes");if(J.length){if(K.likes){J.replaceWith(K.likes)}else{J.remove()}}else{T.find(".siropuChatMessageText").after(K.likes)}break;case"react":var P=T.find(".siropuChatReactions");var O=e(K.reactions);if(O){O.find(".siropuChatReactionView").replaceWith(XF.phrase("view"))}if(P.length){if(O){P.html(O)}else{P.remove()}}else{T.find(".siropuChatMessageText").after(O)}break;case"prune":if(K.prune){if(e.isNumeric(K.prune)){H.find('> li[data-user-id="'+K.prune+'"]').remove()}else{for(var M in K.prune){H.find('> li[data-id="'+K.prune[M]+'"]').remove()}}}else{H.find("> li").each(function(){if(e(this).data("id")<Q){e(this).remove()}})}break}T.attr("data-last-change",K.action[R])}}}}},updateHeaderTitle:function(H){if(this.dynamicTitle){x.find("> span").text(H.data("title"))}},updateRooms:function(Z){var X=false;var Y=false;if(Z.rooms===undefined){return}for(var H in Z.rooms){var N=w.find('.siropuChatRoom.siropuChatMessages[data-room-id="'+H+'"]');var K=w.find('.siropuChatRoom.siropuChatUsers[data-room-id="'+H+'"]');var V=e(Z.rooms[H]["messages"]);var R=Z.rooms[H]["users"];var L=Z.rooms[H]["userCount"];var W=E.find('a[data-room-id="'+H+'"]');var U=K.find(".siropuChatNoRoomUsers");if(this.activeUsers[H]===undefined){this.activeUsers[H]=[]}var T=false;if(Z.inactiveRoomId!==undefined||Z.action!="submit"&&(Z.action=="join"||Z.updateUsers)){if(L){for(var J in R){var O=R[J];var I=O.activity;var S=O.status;var P=O.html;if(J){var aa=K.find('> li[data-user-id="'+J+'"]')}else{var aa=K.find('li[data-username="'+O.username+'"]')}if(P){if(aa.length){if(J==0){aa.find(".siropuChatActivityStatus").attr("data-status",I)}continue}if(U.length){K.html(P)}else{K.prepend(P)}if(J&&e.inArray(J,this.activeUsers[H])==-1){this.activeUsers[H].push(J);T=true}XF.activate(K)}else{if(aa.length){if(I=="inactive"){aa.remove();this.removeUserFromActiveUsers(H,J)}else{this.updateUser(aa,I,S)}}}}if(this.userListOrder=="most_active"){T=true}}else{this.activeUsers[H]=[];this.addNoRoomUsersMessage(K)}if(this.roomTabUserCount){W.find("span").html(L).attr("class","siropuChatTabCount"+(L?"Active":"Inactive"))}Y=true}if(V.length){V=e.grep(V,function(ab){return N.find('> li[data-id="'+e(ab).data("id")+'"]').length?false:true});if(this.inverse){N.prepend(V)}else{N.append(V)}this.delayAutoscroll(Z,N);this.deleteOlderMessages(Z.serverTime,N);if(!W.hasClass("siropuChatActiveTab")){W.addClass("siropuChatNewMessage")}if(e(V).length){X=true}XF.activate(e(".siropuChatRoom.siropuChatMessages > li"))}if(T){var Q=K.find("> li").detach();switch(this.userListOrder){case"most_active":var M=Q.sort(function(ac,ab){return e(ac).data("last-active")-e(ab).data("last-active")});break;case"alphabetically":var M=Q.sort(function(ac,ab){return String.prototype.localeCompare.call(e(ac).data("username").toLowerCase(),e(ab).data("username").toLowerCase())});break}K.html(M)}}if(Y){this.userLastUpdate=Z.serverTime;this.updateNavUserCount(Z)}this.updateLastId(Z);this.updateRoomTabs(Z);this.updateBar(Z,Y);if(X){Z.channel="room";C.trigger("new-message",Z)}},updateConversations:function(M){var R=this;var O=false;this.convUnread={};if(M.convContacts&&(M.action=="start"||M.updateConv)){if(this.convTabCount!="disabled"){j.find("span").html(M.convTabCount).attr("class","siropuChatTabCount"+(M.convTabCount?"Active":"Inactive"))}if(M.convItems!==undefined){this.convItems=M.convItems}for(var Q in M.convContacts){var J=M.convContacts[Q]["activity"];var K=M.convContacts[Q]["status"];var N=M.convContacts[Q]["html"];if(N){s.prepend(N);if(l.length){l.remove()}if(e.inArray(Q,this.convItems)==-1){this.convItems.push(Q)}}else{var P=s.find('> li[data-conv-id="'+Q+'"]');if(P.length){this.updateUser(P,J,K)}}}this.convLastUpdate=M.serverTime}if(M.convMessages){for(var I in M.convMessages){var L=e(M.convMessages[I]);var H=e('.siropuChatConversation.siropuChatMessages[data-conv-id="'+I+'"]');if(H.length){L=e.grep(L,function(S){return H.find('> li[data-id="'+e(S).data("id")+'"]').length?false:true})}else{if(!this.convId||M.convId){H=this.createConversationMessageContainer(I);H.insertBefore(r);this.convId=M.convId?M.convId:I;setTimeout(function(){s.find('li[data-conv-id="'+R.convId+'"]').click()})}}if(this.inverse){H.prepend(L)}else{H.append(L)}XF.activate(e(".siropuChatConversation.siropuChatMessages > li"));this.delayAutoscroll(M,H);this.deleteOlderMessages(M.serverTime,H)}}if(M.convUnread){this.convUnread=M.convUnread;for(var I in M.convUnread){var P=s.find('li[data-conv-id="'+I+'"]');if(!P.hasClass("siropuChatNewMessage")){O=true}if(I!=this.convId||s.is(":hidden")){P.addClass("siropuChatNewMessage")}}if(this.inRoom()){j.addClass("siropuChatNewMessage")}}if(O){M.channel="conversation";C.trigger("new-message",M);this.addBarNewMessageClass();this.orderConversations()}},orderConversations:function(){if(s.find("li.siropuChatNewMessage").length){var I=s.find("> li").detach();var H=I.sort(function(K,J){return Number(e(J).hasClass("siropuChatNewMessage"))>Number(e(K).hasClass("siropuChatNewMessage"))?1:-1});s.html(H)}},hasUnreadConversations:function(){return !e.isEmptyObject(this.convUnread)},markCurrentConversationAsRead:function(){if(this.convUnread[this.convId]!==undefined){var H=this;XF.ajax("POST",XF.canonicalizeUrl("index.php?chat/conversation/"+this.convId+"/mark-as-read"),{conv_unread:this.convUnread[this.convId]},function(I){if(I.convRead){delete H.convUnread[I.convRead];setTimeout(function(){e(".siropuChatConversation:visible .siropuChatMessageRow").removeClass("siropuChatUnread")},5000)}},{skipDefault:true,global:false})}},createRoomMessageContainer:function(H){return e('<ul class="siropuChatRoom siropuChatMessages" data-room-id="'+H+'" data-autoscroll="1" />')},createConversationMessageContainer:function(H){return e('<ul class="siropuChatConversation siropuChatMessages" data-conv-id="'+H+'" data-autoscroll="1" />')},updateNotice:function(I){var J=e("#siropuChatNotice");if(I.notice&&(I.serverTime-this.noticeLastUpdate>=60||!J.length)){var H=e(I.notice);if(J.length&&J.find("span").text()==H.find("span").text()){return}H.find("span").hide();if(J.length){J.replaceWith(H)}else{x.after(H)}setTimeout(function(){H.find("span").fadeIn()});this.noticeLastUpdate=I.serverTime}if(!I.notice&&J.length){J.remove()}},updateUser:function(I,M,H){I.find(".siropuChatActivityStatus").attr("data-status",M);var L=I.find(".siropuChatUserStatus");var K=L.length;if(H){if(K){L.html(H)}else{var J=e('<div class="siropuChatUserStatus" />');J.html(H).appendTo(I)}}else{if(K){L.remove()}}},updateActivityStatus:function(H){if(H.action!="submit"&&this.options.active!=H.active){this.options.active=H.active;C.attr("data-active",H.active);this.resetRefreshInterval()}},updateNavUserCount:function(I){if(!this.displayNavCount){return}var H=f.find("span.badge");H.text(I.userCount);if(I.userCount){H.addClass("badge--active");if(c.is(":visible")){c.attr("data-badge",I.userCount)}}else{H.removeClass("badge--active")}},updateBar:function(H,I){if(!(H.lastRow&&m)){return}z.html(H.lastRow.message);A.attr("data-room-id",H.lastRow.roomId);if(H.action!="submit"&&!this.getMiscSetting("hide_chatters")&&I){q.html(H.userCount)}},updateRoomTabs:function(I){if(this.forceRoom==true||this.loggedIn==false||I.joinedRooms===undefined){return}if(E.length){if(this.lastId&&I.joinedRooms){for(var H in this.lastId){if(e.inArray(Number(H),I.joinedRooms)==-1){this.leaveRoomPostActions(H)}}}else{if(this.getRoomCount()){this.postLogout()}}}},updateLastId:function(H){if(H.lastId===undefined||H.lastId.length===0){return}for(var I in H.lastId){this.lastId[I]=H.lastId[I]}},getRooms:function(){XF.ajax("GET",XF.canonicalizeUrl("index.php?chat/room/list"),{},function(H){if(H.html){XF.setupHtmlInsert(H.html,function(I,J,K){G.html(I)})}})},loadRoom:function(J){var H=this;var I=e(J.roomTab);if(this.getRoomCount()==0){I.removeClass("siropuChatActiveTab")}I.insertBefore(b);var K=this.createRoomMessageContainer(J.roomId);K.prependTo(w);this._initAutoScrollToggle(K);e('<ul class="siropuChatRoom siropuChatUsers" data-room-id="'+J.roomId+'" />').prependTo(w);if(J.action=="join"){this.lastId[J.roomId]=1}this.activeUsers[J.roomId]=J.userIds;this.updateRooms(J);setTimeout(function(){H.doAutoScroll(K)});this.switchRoom(J.roomId);this.toggleLogout()},leaveRoom:function(I){var H=this;var I=I?I:this.roomId;XF.ajax("POST",XF.canonicalizeUrl("index.php?chat/room/"+I+"/leave"),{},function(J){H.leaveRoomPostActions(I)},{skipDefault:true})},leaveRoomPostActions:function(J,H){var L=C.find('[data-room-id="'+J+'"]');var I=E.find('[data-room-id="'+J+'"]');if(I.data("leave")==false){return false}L.remove();delete this.lastId[J];delete this.activeUsers[J];XF.Cookie.remove("siropu_chat_room_id");if(H){var K=E.find("[data-room-id]:last");if(K.length){K.click()}else{b.click()}}this.toggleLogout()},leaveConversationPostActions:function(H){C.find('[data-conv-id="'+H.convId+'"]').remove();this.convItems.splice(e.inArray(H.convId,this.convItems),1);XF.Cookie.remove("siropu_chat_conv_id");if(this.getConvCount()){s.find("li[data-conv-id]:first").click()}else{if(H.noConversations!==undefined){s.html(H.noConversations);XF.activate(s)}}},autoScroll:function(H){var H=H?H:F;if(H.attr("data-autoscroll")==1||this.forceAutoScroll){this.doAutoScroll(H)}},doAutoScroll:function(H){var H=H?H:F;if(this.inverse){H.scrollTop(0)}else{H.scrollTop(1000000)}},delayAutoscroll:function(J,I){var H=this;if(J.hasImages){setTimeout(function(){if(J.action=="submit"){H.doAutoScroll(I)}else{H.autoScroll(I)}},1500)}else{this.autoScroll(I)}},getSoundSetting:function(H){return D.find('input[name="sound['+H+']"]').is(":checked")},getNotificationSetting:function(H){return D.find('input[name="notification['+H+']"]').is(":checked")},getMiscSetting:function(H){return D.find('input[name="'+H+'"]').is(":checked")},getCommand:function(H){return this.commands[H]},getNotificationPhrase:function(I){var H=this.getMessageType(I);switch(H){case"mention":case"public":return XF.phrase("siropu_chat_new_public_message");break;case"private":return XF.phrase("siropu_chat_new_private_message");break;case"whisper":return XF.phrase("siropu_chat_new_whisper_message");break;default:return XF.phrase("siropu_chat_new_message");break}},getMessageType:function(H){return H.channel=="room"?H.lastRow.type:H.convLastRow.type},playSound:function(H){if(XF.isIOS()){return false}if(H.channel=="room"){var I=H.playSound}else{var I=H.convPlaySound}if(this.sounds[I]){this.sounds[I].play()}},initDesktopNotification:function(I){var H=this;if(!("Notification" in g)){return}if(!this.getNotificationSetting(this.getMessageType(I))){return}if(Notification.permission==="granted"){this.sendDesktopNotification(I)}else{if(Notification.permission!=="denied"){Notification.requestPermission(function(J){if(J==="granted"){H.sendDesktopNotification(I)}})}}},sendDesktopNotification:function(K){if(K.channel=="room"){var J=K.lastRow}else{var J=K.convLastRow}var I=this;var H={body:J.text,icon:J.avatar,tag:"siropuChatNotification"};var L=new Notification(this.getNotificationPhrase(K),H);setTimeout(L.close.bind(L),this.notificationTimeout);L.onclick=function(){this.close();g.focus();if(m&&I.isVisible){A.click()}else{I.switchRoom()}}},displayTabNotification:function(I){var H=this;if(this.tabNotification&&!this.tabNotificationInterval){this.tabNotificationInterval=setInterval(function(){e("title").text(e("title").text()==H.pageTitle?H.getNotificationPhrase(I):H.pageTitle)},1500)}},switchRoom:function(K,I){var J=E.find('a[data-room-id="'+K+'"]');var H=J.data("flood-check");this.roomFloodCheck=H?H:this.floodCheck;J.trigger("click",I)},switchConversation:function(H){s.find('li[data-conv-id="'+H+'"]').click()},preSubmit:function(){var H=this;if(XF.isEditorEnabled()){this.editorSetHtml("");this.editorOffPlaceholder("posting")}else{a.find('textarea[name="message"]').val("")}this.responseTimeout=setTimeout(function(){H.editorSetPlaceholder("noresponse");H.editorOn();H.startRefreshInterval()},5000);this.stopRefreshInterval()},postSubmit:function(){if(this.inRoom()&&!this.getRoomCount()||this.inConv()&&!this.getConvCount()){this.editorOffPlaceholder("")}else{this.editorOn();if(!p){this.editorFocus()}else{x.get(0).scrollIntoView({behavior:"smooth",block:"start",inline:"start"})}if(this.inRoom()){this.editorSetPlaceholder("public")}else{this.editorSetPlaceholder("private",s.find('li[data-conv-id="'+this.convId+'"]'))}}clearTimeout(this.responseTimeout);this.startRefreshInterval()},saveSettings:function(I){var H=this;if(!D.length){return}XF.ajax("POST",XF.canonicalizeUrl("index.php?chat/save-settings"),D.serialize(),function(K){if(K.errorHtml){XF.setupHtmlInsert(K.errorHtml,function(L,M){var N=M.h1||M.title||XF.phrase("oops_we_ran_into_some_problems");XF.overlayMessage(N,L)});return true}var J="";if(I!==undefined){J=I.target.name}switch(J){case"inverse":H.inverse=H.getMiscSetting("inverse");H.autoScroll();break;case"maximized":C.toggleClass("siropuChatMaximized");H.adjustContentHeight();if(m&&!C.hasClass("siropuChatMaximized")){C.css("z-index","");w.css("height","")}break;case"display_mode":case"editor_on_top":if(J=="display_mode"&&h){return}XF.flashMessage(XF.phrase("siropu_chat_settings_change_reload_page"),3000);break;case"hide_bot":H.toggleBotMessages();break;case"hide_chatters":C.toggleClass("siropuChatHideUserList");break;case"disable":e("#siropuChatBar").remove();D.parents(".menu").remove();XF.flashMessage(XF.phrase("siropu_chat_has_been_disabled"),5000);XF.setupHtmlInsert(K.html,function(L,M){C.replaceWith(L)});C.trigger("disabled");break;default:if(J.match("sound")){H._initSounds()}break}},{skipDefault:true})},toggleChat:function(H){if(H.target.className.match("fa-")){return}C.toggle();z.toggle();this.isVisible=C.is(":visible");if(this.inRoom()){this.switchRoom(A.attr("data-room-id"))}if(this.inConv()&&this.isVisible&&this.hasUnreadConversations()){this.markCurrentConversationAsRead()}A.removeClass("siropuChatNewMessage");this.doAutoScroll();this.resetRefreshInterval();this.adjustContentHeight();if(!this.screenSizeIs("s")){this.editorFocus()}C.trigger("toggle",this.isVisible)},toggleAutoScroll:function(H){var J=parseInt(H[0].scrollHeight-H.innerHeight());var I=parseInt(H.scrollTop());H.attr("data-autoscroll",0);if(((I==J||I+1==J||I-1==J)&&!this.inverse)||I==0&&this.inverse){H.attr("data-autoscroll",1)}if(I==0&&!this.inverse||((I==J||I+1==J||I-1==J)&&this.inverse)){H.trigger("siropuChat:show-load-more")}},toggleLogout:function(){if(!B.length){return}var H=this.getRoomCount();var I=C.find('a[data-leave="false"]').length;if(H==0||(H-I)==0){B.fadeOut()}else{B.fadeIn()}},toggleBotMessages:function(){var H=e(".siropuChatRoom.siropuChatMessages > li.siropuChatBot");if(this.getMiscSetting("hide_bot")){H.fadeOut()}else{H.fadeIn()}},startRefreshInterval:function(){if(this.isVisible){if(this.options.active){this.refreshInterval=this.refreshActive}else{this.refreshInterval=this.refreshInactive}}else{if(this.options.active){this.refreshInterval=this.refreshActiveHidden}else{this.refreshInterval=this.refreshInactiveHidden}}this.refreshSet=setInterval(e.proxy(this,"refresh"),this.refreshInterval)},resetRefreshInterval:function(){this.stopRefreshInterval();var H=this;setTimeout(function(){H.startRefreshInterval()})},stopRefreshInterval:function(){clearInterval(this.refreshSet)},refresh:function(){var H=this;XF.ajax("GET",XF.canonicalizeUrl("index.php?chat/update"),{users:this.getUserList(),channel:this.channel,room_id:this.roomId,last_id:this.lastId,conv_id:this.convId,conv_unread:this.isVisible?this.convUnread:{},conv_only:this.convOnly,conv_items:this.getConvItems(),conv_last_active:this.convLastActive,conv_last_update:this.convLastUpdate,user_last_update:this.userLastUpdate,is_chat_page:h?1:0,hide_tabs:this.hideTabs?1:0},function(I){H.updateRooms(I);H.updateConversations(I);H.updateNotice(I);H.updateActivityStatus(I);setTimeout(function(){H.doMessageActions(I)})},{skipDefault:true,skipError:true,global:false})},getUserList:function(){var H={};for(var I in this.activeUsers){H[I]=this.activeUsers[I].join(",")}return H},getConvItems:function(){return this.convItems.join(",")},getLastConvId:function(){var H=e('.siropuChatConversation.siropuChatMessages[data-conv-id="'+this.convId+'"]');return H.find("> li:"+(this.inverse?"first":"last")).data("id")},adjustContentHeight:function(){var M=e(g).height();var H=C.height();var J=w.height();var L=A.height();var I=M-H;var K=20;if(e(".p-navSticky").length&&e(".p-navSticky.is-sticky").length){K+=e(".p-navSticky").height()}if(L){K+=L}if(e(".siropuChatAllPages.siropuChatMaximized").length){C.css("z-index",100);w.css("height",(J+I-K)+"px")}else{if(e("#siropuChatFullPage").length){w.css("height",(J+I)+"px")}}this.doAutoScroll()},adjustInputBox:function(){if(n.length&&e('html[dir="LTR"]').length){d.find(".fr-view").css("padding-right",n.outerWidth()+10)}},getFloodCheck:function(){if(this.bypassFloodCheck){return 0}if(this.inRoom()){return this.roomFloodCheck}else{return this.floodCheck}},editorFocus:function(){v.el.focus()},editorOn:function(){if(v){v.edit.on()}},editorOff:function(){if(v){v.edit.off()}},editorInsert:function(H){v.html.insert(H,true)},editorSetHtml:function(H){v.html.set(H);v.selection.setAfter("p");v.selection.restore();if(H){this.editorFocus()}},editorGetHtml:function(){return v.html.get(true)},editorGetText:function(){return e.trim(v.$el.text())},editorSetPlaceholder:function(I,H){var J=" ";switch(I){case"public":J=XF.phrase("siropu_chat_write_public_message");break;case"private":if(this.getConvCount()){J="("+H.data("username")+") "+XF.phrase("siropu_chat_write_private_message")}else{J=XF.phrase("siropu_chat_no_conversations_started")}break;case"posting":J=XF.phrase("siropu_chat_posting_message");break;case"wait":J=XF.phrase("siropu_chat_please_wait");break;case"readonly":J=XF.phrase("siropu_chat_room_is_read_only");break;case"noresponse":J=XF.phrase("siropu_chat_no_response");break;case"nopermission":J=XF.phrase("siropu_chat_do_not_have_permission_to_use");break}if(v){v.opts.placeholderText=J;v.placeholder.refresh()}},editorOffPlaceholder:function(H){this.editorOff();this.editorSetPlaceholder(H)},editorOnPlaceholder:function(H){this.editorOn();this.editorSetPlaceholder(H)},loadSound:function(H){return this.sounds[H]?this.sounds[H]:new Audio(XF.canonicalizeUrl("styles/default/siropu/chat/sounds/"+H+".mp3"))},postLogout:function(){var H=this.getRoomCount();for(var I in this.lastId){this.leaveRoomPostActions(I,H!=0)}if(b.hasClass("siropuChatActiveTab")){this.getRooms()}else{if(!H){b.click()}}},setChannel:function(H){if(this.channel!=H){XF.Cookie.set("siropu_chat_channel",H);if(H=="room"){this.userUpdateInterval=30;this.convUpdateInterval=60}else{this.userUpdateInterval=60;this.convUpdateInterval=30}}this.channel=H},deleteOlderMessages:function(I,H){if(I-this.serverTime>=300&&H.find("> li[data-id]").length>=100&&H.data("autoscroll")==0){H.find(">li[data-id]:nth-child("+(this.inverse?"":"-")+"n+"+this.messageDisplayLimit+")").remove();this.serverTime=I}},getWhosTyping:function(){var H=this;XF.ajax("GET",XF.canonicalizeUrl("data/siropu/chat/"+this.channel+"/"+this.getChannelId()+".json"),{},function(L){var J=L?L:{};var M=[];for(var K in J){var I=J[K];if(K==H.userId){continue}if(Math.floor(Date.now()/1000)-I.t<=3){M.push(I.u)}}if(M.length){i.text(M.join(", ")+" "+XF.phrase("siropu_chat_is_typing")).fadeIn()}else{i.fadeOut()}},{skipDefault:true,skipError:true,global:false})},_initRoomListActions:function(){var H=this;e(t).on("click",".siropuChatRoomInfo h3",function(){var I=e(this).parents("li");if(I.data("joined")){H.switchRoom(I.data("room-id"))}else{I.find(".siropuChatRoomJoin").submit()}});e(t).on("submit",".siropuChatRoomAction form",function(K){K.preventDefault();var J=e(this).find('button[type="submit"]');var I=e(this).find('input[name="password"]');if(I.length){I.toggle().focus();if(!I.val()){return}}J.prop("disabled",true);setTimeout(function(){J.prop("disabled",false);I.val("")},1000);XF.ajax("POST",e(this).attr("action"),{password:I.val(),users:H.getUserList()},function(L){if(L.action=="join"){H.loadRoom(L)}if(L.action=="leave"){H.leaveRoomPostActions(L.roomId)}H.getRooms()})})},_initRoomActions:function(){var H=this;e(t).on("click",".siropuChatRecipients",function(){var I=e(this).data("recipients").split(", ");H.editorSetHtml("/"+H.getCommand("whisper")+" ["+I.join(", ")+"]&nbsp;")});e(t).on("click",".siropuChatTag, .siropuChatUserTag",function(I){var J=H.editorGetText();if(I.target.className.match("username")){I.preventDefault();var K=e(this).text()}else{var K=e(this).next("a").text()}if(J){H.editorInsert(" @"+K)}else{H.editorSetHtml("@"+K+",&nbsp;")}})},_initSubmitForm:function(){var H=this;o.on("editor:init",function(K,I){var J=o.data("buttons-remove");if(!XF.isEditorEnabled()&&J.match(/xfBbCode/)){XF.setIsEditorEnabled(true)}I.events.on("click",function(M){if(H.inConv()){var L=s.find('li[data-conv-id="'+H.convId+'"]');if(L.hasClass("siropuChatNewMessage")){L.removeClass("siropuChatNewMessage")}}});if(H.joinCommand){I.events.on("keyup",function(M){var O=H.editorGetText();var N=O.replace("/"+H.joinCommand,"").trim();if(O.match(/\/join/)&&N){var L=new XF.AutoCompleteResults({onInsert:function(P){H.editorSetHtml(O.replace(N,P));L.hideResults();a.submit()}});XF.ajax("GET",XF.canonicalizeUrl("index.php?chat/room/find"),{q:N},function(P){L.showResults(P.q,P.results,a)},{global:false,error:false})}})}if(!H.canUseChat){H.editorOffPlaceholder("nopermission")}else{if(H.inRoom()&&E.find('a[data-room-id="'+H.roomId+'"]').data("readonly")){H.editorOffPlaceholder("readonly")}else{if(H.inRoom()&&!H.getRoomCount()||H.inConv()&&!H.getConvCount()){H.editorOffPlaceholder("")}}}if(h&&!H.inIframe&&!H.screenSizeIs("s")){XF.EditorHelpers.focus(v)}setTimeout(function(){H.adjustContentHeight();H.adjustInputBox()})});a.on("submit",function(M){M.preventDefault();var J=H.editorGetHtml();var L=H.editorGetText();if(!XF.isEditorEnabled()){var I=d.find('textarea[name="message"]').val();J=I;L=I}if(!L&&!e(J).find("img").length){return H.editorSetHtml("")}var N=e('.siropuChatMessages[data-room-id="'+H.roomId+'"]');var K=e('.siropuChatUsers[data-room-id="'+H.roomId+'"]');H.preSubmit();XF.ajax("POST",XF.canonicalizeUrl("index.php?chat/submit"),{users:H.getUserList(),channel:H.channel,room_id:H.roomId,last_id:H.lastId,conv_id:H.convId,conv_items:H.getConvItems(),conv_unread:H.convUnread,conv_last_id:H.getLastConvId(),message_html:J},function(O){if(O.roomIdle){K.find('> li[data-user-id="'+H.userId+'"]').remove();H.removeUserFromActiveUsers(H.roomId,H.userId);if(!H.activeUsers[H.roomId].length){H.addNoRoomUsersMessage(K)}H.postSubmit();return}if(O.input){H.editorSetHtml(O.input)}if(O.roomTab){H.loadRoom(O);H.postSubmit();return}if(O.find!==undefined){e(".siropuChatMessages:visible").html(e(O.messages)).attr("data-search",O.find);H.doAutoScroll();H.postSubmit();return}if(O.leaveRoom){H.leaveRoomPostActions(O.leaveRoom,true)}if(O.leaveConv){H.leaveConversationPostActions(O)}if(O.logout){H.postLogout()}if(O.html){XF.setupHtmlInsert(O.html,function(P,Q){if(P.length){XF.overlayMessage(Q.title,P)}})}if(O.prune){if(O.prune=="all"){e(".siropuChatMessages[data-room-id]").html("");H.lastId={}}else{if(O.prune=="room"){N.html("")}else{if(O.prune.user_id){N.find('> li[data-user-id="'+O.prune.user_id+'"]').remove()}else{if(O.prune.rows){if(H.inverse){N.find("> li").slice(0,Number(O.prune.rows)).remove()}else{N.find("> li").slice(Number(-O.prune.rows)).remove()}}}}}}if(O.sanctioned){K.find('> li[data-user-id="'+O.sanctioned+'"]').remove()}H.updateRooms(O);H.updateConversations(O);H.updateNotice(O);H.updateActivityStatus(O);if(H.getFloodCheck()){H.editorSetPlaceholder("wait")}setTimeout(function(){H.postSubmit()},H.getFloodCheck());if(H.inConv()){H.convLastActive=O.serverTime}},{global:false})})},_initTabs:function(){var H=this;E.on("click","a",function(K,I){K.preventDefault();e(this).removeClass("siropuChatNewMessage");w.find("> *").hide();E.find("a.siropuChatActiveTab").removeClass("siropuChatActiveTab");e(this).addClass("siropuChatActiveTab");H.editorSetPlaceholder("public");H.updateHeaderTitle(e(this));var J=e(this).data("target");H.setChannel(J.match(/room/)?"room":"conversation");switch(J){case"room":H.roomId=e(this).data("room-id");H.roomFloodCheck=e(this).data("flood-check");XF.Cookie.set("siropu_chat_room_id",H.roomId);w.find('[data-room-id="'+H.roomId+'"]').show();if(e(this).data("readonly")){H.editorOffPlaceholder("readonly")}else{H.editorOnPlaceholder("public")}if(H.isResponsive()){e(".siropuChatRoom.siropuChatUsers").hide()}else{if(!I){H.editorFocus()}}H.autoScroll();H._initWhosTyping();break;case"room-list":G.toggle();H.getRooms();H.editorOffPlaceholder("");H.clearWhosTypingInterval();break;case"conv-list":s.show();H.orderConversations();if(H.getConvCount()){s.find('li[data-conv-id="'+H.convId+'"]').trigger("click",true);H._initWhosTyping()}else{H.editorOffPlaceholder("");H.clearWhosTypingInterval()}break;case"conv-form":r.show();if(!H.screenSizeIs("s")){r.find("input").focus()}H.editorOffPlaceholder("");break}})},_initConversations:function(){var H=this;s.on("click","li[data-conv-id]",function(J,I){H.convId=e(this).data("conv-id");XF.Cookie.set("siropu_chat_conv_id",H.convId);H.updateHeaderTitle(e(this));e(this).removeClass("siropuChatNewMessage");e(".siropuChatConversation.siropuChatMessages").hide();e(this).addClass("siropuChatActiveConversation").siblings().removeClass("siropuChatActiveConversation");var L=e('.siropuChatConversation.siropuChatMessages[data-conv-id="'+H.convId+'"]');if(L.find("> li").length){L.show();H.autoScroll(L);H.markCurrentConversationAsRead()}else{var K=e('<li class="siropuChatLoadingMessages" />');K.html(XF.phrase("siropu_chat_loading_conversation_messages"));L=H.createConversationMessageContainer(H.convId);L.html(K).insertBefore(r).show();H._initAutoScrollToggle(L);XF.ajax("POST",XF.canonicalizeUrl("index.php?chat/conversation/"+H.convId+"/load-messages"),{conv_unread:H.convUnread[H.convId]},function(M){L.html(M.messages);XF.activate(L);setTimeout(function(){H.doAutoScroll(L)})})}H.editorOn();H.editorSetPlaceholder("private",e(this));if(!H.inverse&&L.find("iframe").length){setTimeout(function(){H.autoScroll(L)},1000)}if(H.isResponsive()){if(I){L.hide()}else{s.hide()}}else{if(!I){H.editorFocus()}}});s.on("mouseover mouseout","> li",function(){e(this).find(".siropuChatConversationActions").toggle()})},_initOnLoad:function(){if(this.inverse){return}var H=this;e(".siropuChatMessages:visible .bbImage").on("load",function(){H.doAutoScroll()})},_initAutoScrollToggle:function(I){var H=this;var I=I?I:e(".siropuChatMessages");I.scroll(function(){H.toggleAutoScroll(e(this))})},_initSounds:function(){this.sounds.normal=this.getSoundSetting("normal")?this.loadSound("normal"):"";this.sounds.whisper=this.getSoundSetting("whisper")?this.loadSound("whisper"):"";this.sounds["private"]=this.getSoundSetting("private")?this.loadSound("private"):"";this.sounds.mention=this.getSoundSetting("mention")?this.loadSound("tag"):"";this.sounds.bot=this.getSoundSetting("bot")?this.loadSound("bot"):"";this.sounds.error=this.getSoundSetting("bot")?this.loadSound("error"):""},_initWhosTyping:function(){this.clearWhosTypingInterval();if(this.getChannelId()==0||this.inRoom()&&!this.whosTyping.room||this.inConv()&&!this.whosTyping.conv){return}var H=this;this.whosTypingInterval=setInterval(function(){H.getWhosTyping()},1000)},clearWhosTypingInterval:function(){clearInterval(this.whosTypingInterval);i.fadeOut()},getChannel:function(){return this.channel},getChannelId:function(){return this.inRoom()?this.roomId:this.convId},getRoomId:function(){return this.roomId},getConvId:function(){return this.convId},inRoom:function(){return this.channel=="room"},inConv:function(){return this.channel=="conversation"},escapeRegExp:function(H){return isNaN(H)?H.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"):H},addBarNewMessageClass:function(){if(m&&!this.isVisible){A.addClass("siropuChatNewMessage")}},removeUserFromActiveUsers:function(I,H){var J=this.activeUsers[I];this.activeUsers[I]=J.filter(function(K){return K!=H})},addNoRoomUsersMessage:function(H){H.html(e('<li class="siropuChatNoRoomUsers" />').html(XF.phrase("siropu_chat_no_one_is_chatting")))},toggleUsers:function(){var H=this.getRoomId();var I=this.getConvId();if(this.inRoom()){if(G.is(":hidden")){e('.siropuChatUsers[data-room-id="'+H+'"]').toggle();if(this.screenSizeIs("s")){e('.siropuChatMessages[data-room-id="'+H+'"]').toggle()}}}else{if(this.getConvCount()){s.toggle();if(this.screenSizeIs("s")){e('.siropuChatMessages[data-conv-id="'+I+'"]').toggle()}}}}});XF.SiropuChat.Form=XF.Element.newHandler({options:{edit:false,multiLine:false,timeTyping:Date.now()},init:function(){var J=this;var K=this.$target;var I=K.find("textarea");var H=XF.SiropuChat.Core.prototype;I.on("editor:init",function(M,L){L.opts.pastePlain=true;L.opts.multiLine=J.options.multiLine;L.opts.htmlAllowedTags=["img","a","table","tr","td","blockquote"];L.opts.heightMin=40;L.size.refresh();L.events.on("keydown",function(Q){var O=XF.Cookie.get("siropu_chat_channel");if(Q.which==13){if(J.options.multiLine&&Q.shiftKey){return Q.preventDefault()}K.submit();if(J.options.edit){K.find(".js-overlayClose").click()}}else{if(O=="room"&&H.whosTyping.room!==false||O=="conversation"&&H.whosTyping.conv!==false){var R=H.editorGetText();if(R.length>=2&&Math.floor(Date.now()/1000)-Math.floor(J.options.timeTyping/1000)>=1.5){var N=XF.Cookie.get("siropu_chat_room_id");var S=XF.Cookie.get("siropu_chat_conv_id");var P=O=="room"?N:S;XF.ajax("POST",XF.canonicalizeUrl("index.php?chat/"+O+"/"+P+"/typing"),{},function(T){},{skipDefault:true,skipError:true,global:false});J.options.timeTyping=Date.now()}}}});if(J.options.edit){setTimeout(function(){XF.EditorHelpers.focus(L)},500)}else{L.html.set("")}});e("#siropuChatEditor").on("keyup","textarea",function(L){if(L.which==13&&!XF.isEditorEnabled()&&!J.options.multiLine){K.submit()}})}});XF.SiropuChat.Messages=XF.Element.newHandler({options:{},init:function(){e('a[data-xf-click="siropu-chat-quote"]').remove();this.$target.on("mouseover mouseout",".siropuChatMessageRow",function(){if(e(this).find(".siropuChatMessageActions").length){e(this).find(".siropuChatDateTime, .siropuChatMessageActions").toggle()}})}});XF.SiropuChat.FindRooms=XF.Element.newHandler({options:{pagination:false},init:function(){var H=this;this.$target.on("keyup",function(){var J=e(this).val().trim();if(H.options.pagination){XF.ajax("GET",XF.canonicalizeUrl("index.php?chat/room/list"),{find:J},function(K){XF.setupHtmlInsert(K.html,function(L,N,O){G.html(L);var M=e('#siropuChatRooms input[name="find"]');M.focus();M[0].setSelectionRange(100,100)})})}else{var I=new RegExp(J,"gi");e("#siropuChatRooms > li[data-room-name]").hide().each(function(){if(e(this).data("room-name").match(I)){e(this).show()}})}})}});XF.SiropuChat.RoomPagination=XF.Element.newHandler({options:{},init:function(){var H=this;this.$target.find("a").on("click",function(I){I.preventDefault();XF.ajax("GET",e(this).attr("href"),function(J){XF.setupHtmlInsert(J.html,function(K,L,M){G.html(K)})})})}});XF.SiropuChat.StartConversationForm=XF.Element.newHandler({options:{},init:function(){this.$target.on("submit",function(J){J.preventDefault();var I=e(this).find("input");var H=e(this).find("textarea");if(!I.val().trim()){return I.focus()}if(!H.val().trim()){return H.focus()}XF.ajax("POST",e(this).attr("action"),e(this).serialize()+"&conv_items="+XF.SiropuChat.Core.prototype.getConvItems(),function(K){l=e("#siropuChatNoConversations");if(l.length){l.remove()}XF.SiropuChat.Core.prototype.updateConversations(K);E.find('a[data-target="conv-list"]').click();I.val("");H.val("")})})}});XF.SiropuChat.LeaveConversation=XF.Element.newHandler({options:{},init:function(){this.$target.on("ajax-submit:response",e.proxy(this,"ajaxResponse"))},ajaxResponse:function(I,H){XF.SiropuChat.Core.prototype.updateConversations(H);XF.SiropuChat.Core.prototype.leaveConversationPostActions(H)}});XF.SiropuChat.Like=XF.Click.newHandler({eventNameSpace:"SiropuChatLike",init:function(){},click:function(I){I.preventDefault();var H=this;XF.ajax("POST",this.$target.attr("href"),function(J){if(J.html){XF.setupHtmlInsert(J.html,function(K,L,M){if(K.length){H.$target.parents(".siropuChatMessageRow").replaceWith(K)}})}})}});XF.SiropuChat.Unlike=XF.Click.newHandler({eventNameSpace:"SiropuChatUnlike",init:function(){},click:function(I){I.preventDefault();var H=this;XF.ajax("POST",this.$target.attr("href"),function(J){if(J.html){XF.setupHtmlInsert(J.html,function(K,L,M){if(K.length){H.$target.parents(".siropuChatMessageRow").replaceWith(K)}})}})}});XF.SiropuChat.Quote=XF.Click.newHandler({eventNameSpace:"SiropuChatQuote",init:function(){},click:function(H){H.preventDefault();XF.ajax("POST",this.$target.attr("href"),function(I){if(I.quote){XF.SiropuChat.Core.prototype.editorSetHtml(I.quote)}})}});XF.SiropuChat.LeaveRoom=XF.Click.newHandler({eventNameSpace:"SiropuChatLeaveRoom",init:function(){},click:function(I){I.preventDefault();var H=this;XF.ajax("POST",this.$target.attr("href"),function(J){XF.SiropuChat.Core.prototype.leaveRoomPostActions(J.roomId,true);H.$target.parent(".menu").toggle()})}});XF.SiropuChat.Whisper=XF.Click.newHandler({eventNameSpace:"SiropuChatWhisper",options:{username:""},init:function(){},click:function(O){var Q=this.$target.parents(".menu").attr("id");var J=XF.SiropuChat.Core.prototype.editorGetText();var K=XF.SiropuChat.Core.prototype.getCommand("whisper");var H=[];H.push(this.options.username);if(J.match(/\[(.*?)\]/)){var R=J.indexOf("[");var L=J.indexOf("]");var N=J.substring(R+1,L);if(N.length){var P=N.split(",");for(var M in P){H.push(P[M].trim())}}if(N.match(XF.SiropuChat.Core.prototype.escapeRegExp(this.options.username))){H=H.filter(function(S){return S!=this.options.username})}}var I="";if(H.length){I="/"+K+" ["+H.join(", ")+"] "}XF.SiropuChat.Core.prototype.editorSetHtml(I+"&nbsp;")}});XF.SiropuChat.LoadMoreMessages=XF.Click.newHandler({eventNameSpace:"siropuChatLoadMoreMessages",init:function(){},click:function(K){K.preventDefault();var L=this.$target;if(L.data("complete")){return}var M=L.parents("ul.siropuChatMessages");var I=M.data("room-id");var N=M.data("conv-id");var P=M.attr("data-search");var J=XF.SiropuChat.Core.prototype.getMiscSetting("inverse");if(J){var O=M.find("> li[data-id]:last")}else{var O=M.find("> li[data-id]:first")}if(I){var H="room/"+I}else{var H="conversation/"+N}XF.ajax("GET",XF.canonicalizeUrl("index.php?chat/"+H+"/load-more-messages"),{message_id:O.data("id"),find:P},function(Q){if(Q.messages){if(J){O.after(Q.messages)}else{O.before(Q.messages).get(0).scrollIntoView({behavior:"smooth",block:"nearest",inline:"start"})}XF.activate(O.parent())}if(!Q.hasMore){L.attr("data-complete",true);L.html(XF.phrase("siropu_chat_all_messages_have_been_loaded"));setTimeout(function(){L.fadeOut()},5000)}})}});XF.SiropuChat.EditNotice=XF.Element.newHandler({options:{},init:function(){this.$target.on("ajax-submit:response",e.proxy(this,"ajaxResponse"))},ajaxResponse:function(I,H){if(H.message){XF.flashMessage(H.message,2000)}XF.SiropuChat.Core.prototype.updateNotice(H)}});XF.SiropuChat.ToggleOptions=XF.Click.newHandler({eventNameSpace:"siropuChatToggleOptions",init:function(){},click:function(I){var H=this.$target.parents("fieldset").find("input");H.prop("checked",H.filter(":checked").length?false:true);D.change()}});XF.SiropuChat.ToggleConvForm=XF.Click.newHandler({eventNameSpace:"siropuChatToggleConvForm",init:function(){},click:function(I){var H=this.$target.parent(".siropuChatUserMenu").find("form");H.toggle();if(!XF.SiropuChat.Core.prototype.screenSizeIs("s")){H.find("textarea").focus()}}});XF.SiropuChat.ResetColor=XF.Click.newHandler({eventNameSpace:"SiropuChatResetColor",init:function(){},click:function(I){var H=D.find(".colorPickerBox");H.removeClass("is-active");H.find(".colorPickerBox-sample").attr("style","");D.find('input[name="message_color"]').val("");D.trigger("change")}});XF.SiropuChat.Logout=XF.Element.newHandler({options:{},init:function(){this.$target.on("ajax-submit:response",e.proxy(this,"ajaxResponse"))},ajaxResponse:function(I,H){if(H.errors||H.exception){return}I.preventDefault();if(H.message){XF.flashMessage(H.message,3000)}XF.SiropuChat.Core.prototype.postLogout()}});XF.SiropuChat.EditorButton={init:function(){XF.SiropuChat.EditorButton.initializeDialog();XF.EditorHelpers.dialogs.chat=new XF.SiropuChat.EditorDialogGallery("chat");if(e.FE.COMMANDS.xfCustom_chat){e.FE.COMMANDS.xfCustom_chat.callback=XF.SiropuChat.EditorButton.callback}},initializeDialog:function(){XF.SiropuChat.EditorDialogGallery=XF.extend(XF.EditorDialog,{cache:false,_init:function(J){var K=this;var I=J.$container;var H=I.find(".formSubmitRow-controls");e(".siropuChatDialogInsert").click(function(L){L.preventDefault();e(".js-attachmentFileSelected").each(function(){K.ed.image.insert(e(this).find("a").attr("href"))});K.overlay.hide()});I.on("click",".js-attachmentFile",function(){e(this).toggleClass("js-attachmentFileSelected");if(I.find(".js-attachmentFileSelected").length){H.fadeIn()}else{H.fadeOut()}})}})},callback:function(){XF.EditorHelpers.loadDialog(this,"chat")}};e(t).on("editor:first-start",XF.SiropuChat.EditorButton.init);XF.Element.register("siropu-chat","XF.SiropuChat.Core");XF.Element.register("siropu-chat-form","XF.SiropuChat.Form");XF.Element.register("siropu-chat-messages","XF.SiropuChat.Messages");XF.Element.register("siropu-chat-find-rooms","XF.SiropuChat.FindRooms");XF.Element.register("siropu-chat-room-pagination","XF.SiropuChat.RoomPagination");XF.Element.register("siropu-chat-start-conversation-form","XF.SiropuChat.StartConversationForm");XF.Element.register("siropu-chat-leave-conversation","XF.SiropuChat.LeaveConversation");XF.Element.register("siropu-chat-edit-notice","XF.SiropuChat.EditNotice");XF.Element.register("siropu-chat-logout","XF.SiropuChat.Logout");XF.Click.register("siropu-chat-like","XF.SiropuChat.Like");XF.Click.register("siropu-chat-unlike","XF.SiropuChat.Unlike");XF.Click.register("siropu-chat-quote","XF.SiropuChat.Quote");XF.Click.register("siropu-chat-whisper","XF.SiropuChat.Whisper");XF.Click.register("siropu-chat-leave-room","XF.SiropuChat.LeaveRoom");XF.Click.register("siropu-chat-load-more-messages","XF.SiropuChat.LoadMoreMessages");XF.Click.register("siropu-chat-toggle-options","XF.SiropuChat.ToggleOptions");XF.Click.register("siropu-chat-toggle-conv-form","XF.SiropuChat.ToggleConvForm");XF.Click.register("siropu-chat-reset-color","XF.SiropuChat.ResetColor")}(jQuery,window,document);